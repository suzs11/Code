digitDatasetPath = fullfile('../maldata9_rc_optDimTau_224_224');
imds = imageDatastore(digitDatasetPath, ...
    'IncludeSubfolders',true,'LabelSource','foldernames');
%tbl = countEachLabel(imds);
%minSetCount = min(tbl{:,2});
start_time_train=cputime;
% net = resnet50();
no_person = 3;
%splitting of Database into Training and Test Sets
[trainingSet, testSet] = splitEachLabel(imds, 0.8, 'randomize');
% Data Augmentation

imageSize = [224 224 3];
augmentedTrainingSet56 = augmentedImageDatastore(imageSize, trainingSet, 'ColorPreprocessing', 'gray2rgb');
augmentedTestSet56 = augmentedImageDatastore(imageSize, testSet, 'ColorPreprocessing', 'gray2rgb');
% Design CNN Network
% input layer
inputLayer = imageInputLayer([224 224 3]);

% convolution block 1
convBlock1 = [
    convolution2dLayer(3, 64, 'Padding', 'same','WeightsInitializer', 'he')
    reluLayer()
    convolution2dLayer(3, 64, 'Padding', 'same','WeightsInitializer', 'he')
    reluLayer()
    maxPooling2dLayer(2, 'Stride', 2)
    
    ];
convBlock2 = [
    convolution2dLayer(3, 128, 'Padding', 'same','WeightsInitializer', 'he')
    reluLayer()
    convolution2dLayer(3, 128, 'Padding', 'same','WeightsInitializer', 'he')
    reluLayer()
    maxPooling2dLayer(2, 'Stride', 2)
    ];
convBlock3 = [
    convolution2dLayer(3, 256, 'Padding', 'same','WeightsInitializer', 'he')
    reluLayer()
    convolution2dLayer(3, 256, 'Padding', 'same','WeightsInitializer', 'he')
    reluLayer()
    convolution2dLayer(3, 256, 'Padding', 'same','WeightsInitializer', 'he')
    reluLayer()
    maxPooling2dLayer(2, 'Stride', 2)
    ];
convBlock4 = [
    convolution2dLayer(3, 512, 'Padding', 'same','WeightsInitializer', 'he')
    reluLayer()
    convolution2dLayer(3, 512, 'Padding', 'same','WeightsInitializer', 'he')
    reluLayer()
    convolution2dLayer(3, 512, 'Padding', 'same','WeightsInitializer', 'he')
    reluLayer()
    maxPooling2dLayer(2, 'Stride', 2)
    ];
convBlock5 = [
    convolution2dLayer(3, 512, 'Padding', 'same','WeightsInitializer', 'he')
    reluLayer()
    convolution2dLayer(3, 512, 'Padding', 'same','WeightsInitializer', 'he')
    reluLayer()
    convolution2dLayer(3, 512, 'Padding', 'same','WeightsInitializer', 'he')
    reluLayer()
    maxPooling2dLayer(2, 'Stride', 2)
    
    ];
fullyConnectedBlock = [
    
fullyConnectedLayer(4096)
reluLayer()
fullyConnectedLayer(4096)
reluLayer()
fullyConnectedLayer(9)

softmaxLayer()
classificationLayer()
];
layers = [inputLayer
    convBlock1
    convBlock2
    convBlock3
    convBlock4
    convBlock5
    fullyConnectedBlock
    ];


YValidation56 = testSet.Labels;

K1 = 0.50536;
K2 = 0.013498;
K3 = 17;
K4 = 0.00020352;
options = trainingOptions('sgdm', ...
    'ExecutionEnvironment','auto', ...
    'LearnRateSchedule','piecewise', ... %学习率
    'LearnRateDropFactor',0.5, ...
    'LearnRateDropPeriod',5, ...
    'GradientThreshold',1, ...
    'Momentum', K1,...
    'InitialLearnRate',K2, ...
    'MaxEpochs',ceil(K3), ...
    'L2Regularization', K4,...
    'Shuffle','every-epoch', ...
    'MiniBatchSize', 32,...
    'ValidationData',augmentedTestSet56, ...
    'ValidationFrequency',30, ...
    'Verbose',true, ...
    'Plots','training-progress');
% Train the CNN network, Parameters optimized using WOA
net = trainNetwork(augmentedTrainingSet56,layers,options);
[YPred, Scores] = classify(net,augmentedTestSet56);


accuracy = sum(YPred == YValidation56)/numel(YValidation56);
TestError = 1-mean(YPred==YValidation56);
formatSpace = 'The best accuracy of test set classification is %f7\n';
fprintf(formatSpace,accuracy)

figc = figure('Units','normalized','Position',[0.2 0.2 0.4 0.4]);

cm = confusionchart(YValidation56,YPred);
cm.Title = 'Confusion Matrix for Test Data';
cm.ColumnSummary = 'column-normalized';
cm.RowSummary = 'row-normalized';
%saveas(figc,'cnnConfusion.eps','epsc')

