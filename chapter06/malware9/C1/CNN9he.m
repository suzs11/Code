digitDatasetPath = fullfile('../maldata9_rc_optDimTau_224_224');
imds = imageDatastore(digitDatasetPath, ...
        'IncludeSubfolders',true,'LabelSource','foldernames');
%tbl = countEachLabel(imds);
%minSetCount = min(tbl{:,2});
start_time_train=cputime;
% net = resnet50();
no_person = 3;
%splitting of Database into Training and Test Sets
[trainingSet, testSet] = splitEachLabel(imds, 0.8, 'randomize');
% Data Augmentation
    
imageSize = [224 224 3];
augmentedTrainingSet56 = augmentedImageDatastore(imageSize, trainingSet, 'ColorPreprocessing', 'gray2rgb');
augmentedTestSet56 = augmentedImageDatastore(imageSize, testSet, 'ColorPreprocessing', 'gray2rgb');
% Design CNN Network
layers = [
    imageInputLayer([224 224 3])
    
    convolution2dLayer(5,16,'Padding','same','WeightsInitializer', 'he')
    batchNormalizationLayer
    reluLayer
    
    convolution2dLayer(5,16,'Padding','same','WeightsInitializer', 'he')
    batchNormalizationLayer
    reluLayer
    maxPooling2dLayer(2,'Stride',2)
    
    convolution2dLayer(3,16,'Padding','same','WeightsInitializer', 'he')
    batchNormalizationLayer
    reluLayer   
    
    convolution2dLayer(3,16,'Padding','same','WeightsInitializer', 'he')
    batchNormalizationLayer
    reluLayer
    maxPooling2dLayer(2,'Stride',2)

    convolution2dLayer(3,16,'Padding','same','WeightsInitializer', 'he')
    batchNormalizationLayer
    reluLayer
    
    fullyConnectedLayer(9)
    softmaxLayer
    classificationLayer];
YValidation56 = testSet.Labels;
% save augmentedTrainingSet56 augmentedTrainingSet56;
% save  augmentedTestSet56  augmentedTestSet56;
% save YValidation56 YValidation56
K1 =0.63531;
K2 = 0.010546;
K3 = 10;
K4 = 0.00046247;
options = trainingOptions('sgdm', ...
				'ExecutionEnvironment','auto', ...
				'LearnRateSchedule','piecewise', ... %学习率
				'LearnRateDropFactor',0.5, ...  
				'LearnRateDropPeriod',5, ...
				'GradientThreshold',1, ...
				'Momentum', K1,...
				'InitialLearnRate',K2, ...
				'MaxEpochs',ceil(K3), ...
				'L2Regularization', K4,...    
				'Shuffle','every-epoch', ...
				'MiniBatchSize', 32,...
				'ValidationData',augmentedTestSet56, ...
				'ValidationFrequency',30, ...
				'Verbose',true, ...
				'Plots','training-progress');
% Train the CNN network, Parameters optimized using WOA 
net = trainNetwork(augmentedTrainingSet56,layers,options);
[YPred, Scores] = classify(net,augmentedTestSet56);

accuracy = sum(YPred == YValidation56)/numel(YValidation56);
TestError = 1-mean(YPred==YValidation56);
formatSpace = 'The best accuracy of test set classification is %f7\n';
fprintf(formatSpace,accuracy)
